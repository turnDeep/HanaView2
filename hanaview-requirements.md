# HanaView 要件定義書

## 1. プロジェクト概要

### 1.1 背景と目的
個人投資家が毎朝の市場チェックに多くの時間を費やしている現状を改善し、効率的かつ安全に市場情報を把握できるツールが必要とされている。

**目的：** 
- 毎朝5分で米国市場の重要情報を確認できる統合ダッシュボードを提供
- セキュアな認証機能により、個人情報を保護
- Push通知により、タイムリーな情報更新を通知
- HWB戦略に基づく自動銘柄スキャン機能を提供

### 1.2 スコープ
- 米国株式市場の主要指標の可視化
- 市況ニュースの自動収集と表示
- AIによる市況解説の自動生成
- 経済指標・決算カレンダーの提供
- **【NEW】PIN認証によるアクセス制御**
- **【NEW】Push通知機能（PWA対応）**
- **【NEW】HWB戦略に基づくRussell 3000銘柄の自動スキャン**
- **【NEW】個別銘柄の詳細分析機能**

### 1.3 ターゲットユーザー
- 日本在住の個人投資家
- 米国株投資を行っている、または検討している個人
- 毎朝の市場チェックを効率化したい投資家
- **【NEW】テクニカル分析に基づいた銘柄選定を行いたい投資家**

## 2. 機能要件

### 2.1 認証・セキュリティ機能【NEW】

#### 2.1.1 PIN認証
- **目的：** 不正アクセスを防止し、個人の投資情報を保護
- **要件：**
  - 6桁のPINによる認証
  - 環境変数でPINを設定可能
  - デフォルトPIN: 123456（変更推奨）
  - 最大5回の認証失敗でロックアウト
  - JWTトークンによる認証状態の維持（30日間）
  - LocalStorageとIndexedDBへのトークン保存

#### 2.1.2 セキュリティキー管理
- **目的：** セキュアな通信と通知機能の実現
- **要件：**
  - JWT Secret Keyの自動生成
  - VAPIDキーペア（公開鍵・秘密鍵）の自動生成
  - `data/security_keys.json`への永続化
  - 環境変数からのキー読み込みサポート
  - 初回起動時の自動セットアップ

### 2.2 Push通知機能【NEW】

#### 2.2.1 通知配信
- **目的：** データ更新をリアルタイムで通知
- **要件：**
  - Service WorkerによるPush通知実装
  - VAPID認証によるセキュアな通知配信
  - データ更新時の自動通知（朝6:30前後）
  - 通知のオプトイン機能
  - 通知クリックでアプリ起動

#### 2.2.2 通知管理
- **目的：** ユーザーごとの通知設定管理
- **要件：**
  - Push購読情報の保存（`data/push_subscriptions.json`）
  - 無効なサブスクリプションの自動削除（410エラー時）
  - 手動テスト通知の送信機能
  - 通知トークンのクッキーベース認証

### 2.3 市況概観機能

#### 2.3.1 Fear & Greed Index表示
- **目的：** 市場のセンチメントを数値で正確に把握
- **要件：**
  - CNN Fear & Greed APIからデータ取得
  - Matplotlibによるカスタムゲージチャート生成
  - 以下のデータを表示：
    - 現在のインデックス値とカテゴリ
    - 前日比、1週間前、1ヶ月前、1年前のデータ
  - 画像ファイル（PNG）として保存・表示
  - 毎日自動更新

#### 2.3.2 VIX指数チャート
- **目的：** ボラティリティの推移を把握
- **要件：**
  - 過去60日分のデータ取得
  - 4時間足にリサンプリング
  - lightweight-chartsによる表示
  - 現在値を強調表示

#### 2.3.3 米国10年債利回りチャート
- **目的：** 金利動向を把握
- **要件：**
  - ^TNX（10年債利回り）データを使用
  - 過去60日分のデータ取得
  - 4時間足にリサンプリング
  - lightweight-chartsによる表示

#### 2.3.4 AI市況解説
- **目的：** 初心者でも理解できる市況サマリー提供
- **要件：**
  - OpenAI API（gpt-4.1またはgpt-4o-mini）を使用
  - 300字程度の解説
  - VIX、10年債、Fear & Greedデータに基づく分析
  - 過去1ヶ月の推移を考慮した解説

### 2.4 ヒートマップ機能

#### 2.4.1 NASDAQ 100ヒートマップ
- **目的：** NASDAQ主要銘柄のパフォーマンスを一覧表示
- **要件：**
  - yfinanceによる各銘柄データ取得
  - Wikipediaから銘柄リスト取得
  - 1日・1週間・1ヶ月のパフォーマンス表示
  - 上位30銘柄を表示
  - D3.jsによるTreemapビジュアライゼーション
  - パフォーマンスに応じた色分け
  - AI解説：市場傾向の分析

#### 2.4.2 S&P 500 & セクターETFヒートマップ
- **目的：** S&P500とセクター別パフォーマンスを表示
- **要件：**
  - S&P500上位30銘柄＋主要11セクターETF
  - セクターETF: XLK, XLY, XLV, XLP, XLB, XLU, XLI, XLC, XLRE, XLF, XLE
  - 1日・1週間・1ヶ月のパフォーマンス表示
  - D3.jsによるTreemapビジュアライゼーション
  - AI解説：セクターローテーション分析

### 2.5 ニュース機能
- **目的：** 短時間で市場の空気感と重要材料を把握
- **要件：**
  - Yahoo Financeから主要指数のニュース取得
  - 重複除去処理
  - 月曜：過去1週間のニュース（168時間）
  - 火〜金：過去24時間のニュース
  - OpenAI APIによる自動要約
  - 構成要素：
    * **今朝の3行サマリー**: 全体のムードを伝える
    * **主要トピック3つ**: 事実→解釈→市場への影響
  - ソースアイコンの表示
  - 外部リンク機能

### 2.6 経済指標・決算カレンダー

#### 2.6.1 経済指標カレンダー
- **目的：** 重要な経済イベントを事前把握
- **要件：**
  - Monexから経済指標情報を取得
  - **対象期間**: 
    - 月曜：今週の指標（6日間）
    - 火〜金：当日朝から翌日朝まで（26時間）
  - **表示条件**: 重要度★★以上
  - 表示項目：日時、指標名、予測、前回、重要度
  - 国旗アイコン表示
  - AI解説：最重要指標5つの影響分析

#### 2.6.2 決算カレンダー
- **目的：** 重要企業の決算スケジュール把握
- **要件：**
  - Monexから米国・日本の決算情報を取得
  - **対象期間**:
    - 月曜：今週の決算
    - 火〜金：当日〜翌日の決算
  - **表示条件**:
    - 米国：主要100銘柄の決算
    - 日本：主要150銘柄の決算
  - 表示項目：日時、ティッカー、企業名
  - AI解説：注目決算3〜5社の市場影響分析

### 2.7 AIコラム機能
- **目的：** 週次・日次の投資戦略参考情報を提供
- **要件：**
  - **月曜日**: 週次レポート（今週の注目ポイント、400字程度）
  - **火〜金曜日**: 日次レポート（今日の注目ポイント、300字程度）
  - Hanaメモファイル（投資戦略ガイド）を参考資料として使用
  - 経済指標、決算、ニュース、市場データを総合的に分析
  - 「ロング」「ショート」等の直接的な投資指示は避ける

### 2.8 HWB 200MA戦略スキャナー【NEW】

#### 2.8.1 自動銘柄スキャン
- **目的：** HWB戦略に適合する銘柄を自動検出
- **要件：**
  - Russell 3000銘柄を対象
  - 毎日午前6:35に自動実行
  - SQLiteによる価格データのキャッシング
  - yfinanceによるデータ取得
  - 以下の4つのルールチェック:
    1. トレンドチェック（週足SMA200、日足SMA200/EMA200）
    2. セットアップ検出（SMA200とEMA200の間での保ち合い）
    3. FVG（Fair Value Gap）検出
    4. ブレイクアウト検出
  - スコアリングシステム（0-100点）

#### 2.8.2 個別銘柄分析
- **目的：** 任意のティッカーを詳細分析
- **要件：**
  - ティッカーシンボル入力による分析
  - 既存データの即座表示
  - 強制再分析オプション（force=true）
  - lightweight-chartsによる高度なチャート表示
  - 以下の要素を表示:
    - ローソク足チャート
    - SMA200, EMA200, 週足SMA200
    - セットアップゾーン（Setup Zone）
    - FVGゾーン（Fair Value Gap）
    - ブレイクアウトマーカー
  - RectanglePrimitive（カスタムプラグイン）によるゾーン描画

#### 2.8.3 データ管理
- **目的：** 効率的なデータ保存と取得
- **要件：**
  - SQLiteデータベース（`data/hwb/hwb_cache.db`）
    - 日足データテーブル
    - 週足データテーブル
    - メタデータテーブル
  - 個別銘柄JSONファイル（`data/hwb/symbols/{TICKER}.json`）
  - デイリーサマリーJSON（`data/hwb/daily/{YYYY-MM-DD}.json`）
  - 最新サマリーへのシンボリックリンク（`latest.json`）
  - 10年分の過去データ保持
  - 増分更新機能

### 2.9 データ更新機能
- **目的：** 最新データの自動取得
- **要件：**
  - 毎日朝6:15にデータ取得（fetch）
  - 毎日朝6:28にレポート生成（generate）
  - レポート生成後のPush通知送信
  - 毎日朝6:35にHWBスキャン実行
  - cronによる自動実行
  - タイムゾーン: Asia/Tokyo
  - ログ記録機能（`logs/`ディレクトリ）

## 3. 非機能要件

### 3.1 パフォーマンス要件
- ページ読み込み時間：3秒以内
- 認証処理：1秒以内
- データ取得処理（fetch）：10分以内で完了
- レポート生成処理（generate）：5分以内で完了
- HWBスキャン処理：60分以内で完了（約3000銘柄）
- チャート描画：1秒以内
- 個別銘柄分析（既存データ）：即座
- 個別銘柄分析（新規データ）：10-30秒

### 3.2 可用性要件
- サービス稼働率：99%以上
- データ取得失敗時のフォールバック機能
- エラー発生時の適切なメッセージ表示
- 無効なPush購読の自動削除
- セキュリティキーの自動生成・復旧機能

### 3.3 セキュリティ要件
- PIN認証による アクセス制御
- JWTトークンによるセッション管理
- APIキーの環境変数管理
- セキュリティキーの安全な保存（`data/security_keys.json`）
- トークンの有効期限管理（30日間）
- HTTPSによる通信（本番環境推奨）
- 外部APIアクセスのレート制限対応
- 認証クッキーのSecure/SameSite設定

### 3.4 運用要件
- Dockerによるコンテナ化
- Cronによる自動実行（cron環境変数の適切な設定）
- ログファイルの自動ローテーション
- 7日以前のデータファイル自動削除
- HWBキャッシュデータベースの自動管理
- セキュリティキーのバックアップ推奨

### 3.5 互換性要件
- PWA対応（Progressive Web App）
- Service Worker対応ブラウザ必須
- Push通知対応ブラウザ必須
- モバイル端末対応（レスポンシブデザイン）
- 主要ブラウザ対応（Chrome 90+、Safari 14+、Firefox 88+、Edge 90+）
- タブレット端末での表示最適化
- スワイプジェスチャーによるタブ切り替え

### 3.6 スケーラビリティ要件
- HWBスキャン対象銘柄数：3000銘柄対応
- 並列処理による高速化（最大5ワーカー）
- バッチサイズ：20銘柄ごと
- SQLiteによる効率的なデータキャッシング

## 4. 制約事項

### 4.1 技術的制約
- yfinanceの15分遅延データ
- 外部APIのレート制限
- OpenAI APIの利用料金制約
- Russell 3000銘柄リストはCSVファイルで管理
- Service Worker のHTTPS要件（localhost除く）
- Push通知のブラウザ依存性

### 4.2 法的制約
- 金融データの再配布に関する制限
- 投資助言に該当しない内容制限
- プライバシー情報の適切な管理

### 4.3 運用制約
- 米国市場の営業時間（夏時間・冬時間）考慮
- 日本時間での表示・運用
- 初回起動時のセキュリティキー生成
- HWBスキャンは市場終了後に実行

## 5. 前提条件

- Docker環境が利用可能
- OpenAI APIキーを保有
- インターネット接続環境
- 最低5GBのストレージ容量（HWBデータベース含む）
- **【NEW】6桁のPINを設定**
- **【NEW】Push通知を有効化（ブラウザ設定）**

## 6. 用語定義

| 用語 | 定義 |
|------|------|
| VIX | ボラティリティ・インデックス、恐怖指数 |
| Fear & Greed Index | CNNが提供する市場センチメント指標 |
| ヒートマップ | 数値データを色で視覚化した図表 |
| 4時間足 | 4時間ごとの価格変動を示すチャート |
| FOMC | 連邦公開市場委員会 |
| HWB | High-Water Mark Breakout（高値ブレイクアウト戦略） |
| FVG | Fair Value Gap（公正価値ギャップ） |
| SMA | Simple Moving Average（単純移動平均） |
| EMA | Exponential Moving Average（指数移動平均） |
| PWA | Progressive Web App |
| VAPID | Voluntary Application Server Identification（自発的アプリケーションサーバー識別） |
| JWT | JSON Web Token |
| PIN | Personal Identification Number（個人識別番号） |

## 7. 今後の拡張予定

### 7.1 短期（3ヶ月以内）
- パスワードリセット機能
- 複数ユーザーサポート
- カスタム通知設定（時刻・内容）

### 7.2 中期（6ヶ月以内）
- ポートフォリオ管理機能
- HWB戦略のカスタマイズ
- バックテスト機能

### 7.3 長期（1年以内）
- モバイルアプリ（iOS/Android）
- リアルタイムデータ対応
- マルチアカウント管理
- 有料プラン導入
